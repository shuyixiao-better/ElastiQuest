# è·¨åŸŸï¼ˆCORSï¼‰é…ç½®è¯´æ˜

## ğŸ¯ é—®é¢˜è¯´æ˜

åœ¨ä½¿ç”¨å±€åŸŸç½‘ IP è®¿é—®åº”ç”¨æ—¶ï¼ˆä¾‹å¦‚ `http://10.10.0.153:3000`ï¼‰ï¼Œä¼šé‡åˆ°ä¸¤ä¸ªè·¨åŸŸé—®é¢˜ï¼š

### 1. Next.js 16 è·¨åŸŸè­¦å‘Š
```
âš  Cross origin request detected from 10.10.0.153 to /_next/* resource.
In a future major version of Next.js, you will need to explicitly configure "allowedDevOrigins"
```

### 2. åç«¯ API CORS é”™è¯¯
```
Access to fetch at 'http://localhost:8080/api/...' from origin 'http://10.10.0.153:3000' 
has been blocked by CORS policy
```

## âœ… è§£å†³æ–¹æ¡ˆ

### å‰ç«¯é…ç½®ï¼ˆNext.jsï¼‰

**æ–‡ä»¶**: `frontend/next.config.ts`

```typescript
import os from "os";

// è‡ªåŠ¨è·å–æœ¬æœºæ‰€æœ‰ IP åœ°å€
function getLocalIPs(): string[] {
  const interfaces = os.networkInterfaces();
  const ips: string[] = [];

  for (const name of Object.keys(interfaces)) {
    const iface = interfaces[name];
    if (iface) {
      for (const addr of iface) {
        if (addr.family === 'IPv4' && !addr.internal) {
          ips.push(addr.address);
        }
      }
    }
  }

  return ips;
}

const nextConfig: NextConfig = {
  // å…è®¸å¼€å‘ç¯å¢ƒçš„è·¨åŸŸè¯·æ±‚
  allowedDevOrigins: [
    'localhost',
    '127.0.0.1',
    ...getLocalIPs(), // è‡ªåŠ¨æ·»åŠ æœ¬æœºæ‰€æœ‰ IP
  ],
};
```

**ç‰¹æ€§**:
- âœ… è‡ªåŠ¨æ£€æµ‹æœ¬æœºæ‰€æœ‰ç½‘å¡çš„ IP åœ°å€
- âœ… æ”¯æŒå¤šç½‘å¡ï¼ˆä»¥å¤ªç½‘ã€WiFi ç­‰ï¼‰
- âœ… æ— éœ€æ‰‹åŠ¨é…ç½® IP
- âœ… åªåœ¨å¼€å‘ç¯å¢ƒç”Ÿæ•ˆ

### åç«¯é…ç½®ï¼ˆSpring Bootï¼‰

**æ–‡ä»¶**: `backend/src/main/java/com/elasticquest/backend/config/CorsConfig.java`

```java
@Configuration
public class CorsConfig {

    @Bean
    public CorsFilter corsFilter() {
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        CorsConfiguration config = new CorsConfiguration();
        
        // å¼€å‘ç¯å¢ƒï¼šå…è®¸æ‰€æœ‰æ¥æºï¼ˆæ”¯æŒå±€åŸŸç½‘ IP è®¿é—®ï¼‰
        config.setAllowedOriginPatterns(Arrays.asList("*"));
        
        // å…è®¸çš„ HTTP æ–¹æ³•
        config.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"));
        
        // å…è®¸çš„è¯·æ±‚å¤´
        config.setAllowedHeaders(Arrays.asList("*"));
        
        // å…è®¸å‘é€å‡­è¯
        config.setAllowCredentials(true);
        
        // é¢„æ£€è¯·æ±‚çš„ç¼“å­˜æ—¶é—´
        config.setMaxAge(3600L);
        
        // æš´éœ²çš„å“åº”å¤´ï¼ˆç”¨äº SSEï¼‰
        config.setExposedHeaders(Arrays.asList(
            "Content-Type",
            "Cache-Control",
            "Content-Encoding",
            "Date",
            "Keep-Alive",
            "Connection"
        ));
        
        source.registerCorsConfiguration("/**", config);
        return new CorsFilter(source);
    }
}
```

**ç‰¹æ€§**:
- âœ… ä½¿ç”¨ `setAllowedOriginPatterns("*")` å…è®¸æ‰€æœ‰æ¥æº
- âœ… æ”¯æŒå‡­è¯ï¼ˆCredentialsï¼‰
- âœ… æš´éœ²å¿…è¦çš„å“åº”å¤´ï¼ˆSSE éœ€è¦ï¼‰
- âœ… æ”¯æŒæ‰€æœ‰å¸¸ç”¨ HTTP æ–¹æ³•

## ğŸ”§ é…ç½®è¯´æ˜

### allowedDevOrigins vs allowedOriginPatterns

| é…ç½®é¡¹ | ä½ç½® | ä½œç”¨ | é€‚ç”¨åœºæ™¯ |
|--------|------|------|----------|
| `allowedDevOrigins` | Next.js | å…è®¸è®¿é—® Next.js é™æ€èµ„æº | å‰ç«¯å¼€å‘ç¯å¢ƒ |
| `allowedOriginPatterns` | Spring Boot | å…è®¸è®¿é—®åç«¯ API | åç«¯ CORS |

### ä¸ºä»€ä¹ˆä½¿ç”¨ allowedOriginPatterns è€Œä¸æ˜¯ allowedOriginsï¼Ÿ

å½“ `allowCredentials = true` æ—¶ï¼Œä¸èƒ½ä½¿ç”¨ `allowedOrigins("*")`ï¼Œå¿…é¡»ä½¿ç”¨ `allowedOriginPatterns("*")`ã€‚

## ğŸŒ æ”¯æŒçš„è®¿é—®æ–¹å¼

é…ç½®å®Œæˆåï¼Œä»¥ä¸‹æ‰€æœ‰æ–¹å¼éƒ½å¯ä»¥è®¿é—®ï¼š

### å‰ç«¯è®¿é—®
- âœ… `http://localhost:3000`
- âœ… `http://127.0.0.1:3000`
- âœ… `http://10.10.0.153:3000` (ä»¥å¤ªç½‘)
- âœ… `http://192.168.1.100:3000` (WiFi)

### åç«¯è®¿é—®
- âœ… `http://localhost:8080/api`
- âœ… `http://127.0.0.1:8080/api`
- âœ… `http://10.10.0.153:8080/api`
- âœ… `http://192.168.1.100:8080/api`

### è·¨åŸŸè®¿é—®
- âœ… å‰ç«¯ `10.10.0.153:3000` â†’ åç«¯ `localhost:8080` âœ…
- âœ… å‰ç«¯ `localhost:3000` â†’ åç«¯ `10.10.0.153:8080` âœ…
- âœ… å‰ç«¯ `10.10.0.153:3000` â†’ åç«¯ `10.10.0.153:8080` âœ…

## ğŸ”’ ç”Ÿäº§ç¯å¢ƒé…ç½®

**é‡è¦**: å½“å‰é…ç½®é€‚ç”¨äºå¼€å‘ç¯å¢ƒã€‚ç”Ÿäº§ç¯å¢ƒåº”è¯¥ï¼š

### å‰ç«¯ï¼ˆNext.jsï¼‰
```typescript
// ç”Ÿäº§ç¯å¢ƒä¸éœ€è¦ allowedDevOrigins
// Next.js ä¼šè‡ªåŠ¨å¤„ç†
```

### åç«¯ï¼ˆSpring Bootï¼‰
```java
// ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶
String allowedOrigins = System.getenv("ALLOWED_ORIGINS");
if (allowedOrigins != null) {
    config.setAllowedOrigins(Arrays.asList(allowedOrigins.split(",")));
} else {
    // å¼€å‘ç¯å¢ƒ
    config.setAllowedOriginPatterns(Arrays.asList("*"));
}
```

æˆ–è€…åœ¨ `application.yml` ä¸­é…ç½®ï¼š
```yaml
cors:
  allowed-origins:
    - https://your-domain.com
    - https://www.your-domain.com
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ä»ç„¶æœ‰ CORS é”™è¯¯

**æ£€æŸ¥**:
1. ç¡®ä¿åç«¯å·²é‡å¯ï¼ˆä¿®æ”¹ Java ä»£ç éœ€è¦é‡å¯ï¼‰
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„å…·ä½“é”™è¯¯ä¿¡æ¯

**è§£å†³**:
```bash
# é‡å¯åç«¯
cd backend
mvn spring-boot:run

# æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
Ctrl + Shift + Delete
```

### é—®é¢˜ 2: Next.js è­¦å‘Šä»ç„¶å­˜åœ¨

**æ£€æŸ¥**:
1. ç¡®ä¿å‰ç«¯å·²é‡å¯
2. æ£€æŸ¥ `next.config.ts` æ˜¯å¦æ­£ç¡®ä¿å­˜

**è§£å†³**:
```bash
# é‡å¯å‰ç«¯
cd frontend
# Ctrl + C åœæ­¢
npm run dev
```

### é—®é¢˜ 3: SSE æµå¼å“åº”ä¸­æ–­

**æ£€æŸ¥**:
1. ç¡®ä¿ `exposedHeaders` åŒ…å«å¿…è¦çš„å¤´
2. æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§

**è§£å†³**:
```java
// åœ¨ CorsConfig.java ä¸­æ·»åŠ 
config.setExposedHeaders(Arrays.asList(
    "Content-Type",
    "Cache-Control",
    "Content-Encoding",
    "Date",
    "Keep-Alive",
    "Connection"
));
```

## ğŸ“ æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•æœ¬åœ°è®¿é—®
```bash
# æµè§ˆå™¨è®¿é—®
http://localhost:3000
http://localhost:3000/rag
```

### 2. æµ‹è¯•å±€åŸŸç½‘è®¿é—®
```bash
# è·å–æœ¬æœº IPï¼ˆå¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºï¼‰
# æµè§ˆå™¨è®¿é—®
http://10.10.0.153:3000
http://10.10.0.153:3000/rag
```

### 3. æµ‹è¯• API è°ƒç”¨
```bash
# åœ¨ RAG é¡µé¢è¾“å…¥é—®é¢˜å¹¶æäº¤
# æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ CORS é”™è¯¯
# æ£€æŸ¥æ˜¯å¦èƒ½æ­£å¸¸æ”¶åˆ°æµå¼å“åº”
```

## ğŸ¯ éªŒè¯æˆåŠŸ

å¦‚æœé…ç½®æˆåŠŸï¼Œä½ åº”è¯¥ï¼š
- âœ… ä¸å†çœ‹åˆ° Next.js è·¨åŸŸè­¦å‘Š
- âœ… ä¸å†çœ‹åˆ° CORS é”™è¯¯
- âœ… å¯ä»¥ä»ä»»ä½• IP è®¿é—®å‰ç«¯
- âœ… å¯ä»¥æ­£å¸¸è°ƒç”¨åç«¯ API
- âœ… RAG åŠŸèƒ½æ­£å¸¸å·¥ä½œ

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å¼€å‘ç¯å¢ƒ**: ä½¿ç”¨å®½æ¾çš„ CORS é…ç½®ï¼ˆå½“å‰é…ç½®ï¼‰
2. **æµ‹è¯•ç¯å¢ƒ**: é™åˆ¶ä¸ºæµ‹è¯•åŸŸå
3. **ç”Ÿäº§ç¯å¢ƒ**: ä¸¥æ ¼é™åˆ¶ä¸ºç”Ÿäº§åŸŸå
4. **å®‰å…¨æ€§**: æ°¸è¿œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `*`

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Next.js allowedDevOrigins](https://nextjs.org/docs/app/api-reference/config/next-config-js/allowedDevOrigins)
- [Spring Boot CORS](https://spring.io/guides/gs/rest-service-cors/)
- [MDN CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)

